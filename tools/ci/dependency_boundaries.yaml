rules:
  # R1 — No HTTP in packages/**
  - id: R1_NO_HTTP_IN_PACKAGES
    description: "packages/** must not import HTTP framework/runtime symbols"
    severity: error
    paths:
      - "packages/**/*.py"
    forbidden_imports:
      - "fastapi"
      - "starlette"
      - "uvicorn"

  # R2 — Routes are glue (no infra clients in routes)
  - id: R2_ROUTES_NO_INFRA_CLIENTS
    description: "routes/** must not import DB/search clients directly"
    severity: error
    paths:
      - "services/api/src/routes/**/*.py"
    forbidden_imports:
      - "psycopg"
      - "asyncpg"
      - "sqlalchemy"
      - "opensearch"
      - "opensearchpy"
      - "elasticsearch"
      - "qdrant_client"

  # R4 — Single source of behavior guardrail
  # Block API-internal search impl imports from routes (force migration to packages/search)
  - id: R4_NO_API_SEARCH_IMPL_FROM_ROUTES
    description: "routes/** must not import services.api.src.search implementation"
    severity: error
    paths:
      - "services/api/src/routes/**/*.py"
    forbidden_imports:
      - "services.api.src.search.*"

  # R3 — Workers don’t own clients (progressive)
  - id: R3_WORKERS_NO_LOCAL_CLIENTS
    description: "workers/** should not own infra clients (allowlist temporarily permitted)"
    severity: error
    paths:
      - "services/workers/**/src/**/*.py"
    forbidden_imports:
      - "psycopg"
      - "asyncpg"
      - "sqlalchemy"
      - "opensearch"
      - "opensearchpy"
      - "elasticsearch"
      - "qdrant_client"

  # Tests: warning-only (drift often starts in tests)
  - id: T1_TESTS_WARN_ON_INFRA_CLIENTS
    description: "tests importing infra clients is a drift smell (warn)"
    severity: warning
    paths:
      - "tests/**/*.py"
      - "services/**/tests/**/*.py"
    forbidden_imports:
      - "psycopg"
      - "asyncpg"
      - "sqlalchemy"
      - "opensearch"
      - "opensearchpy"
      - "elasticsearch"
      - "qdrant_client"
